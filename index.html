<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>視覺光學實驗室 | Vision Optics Lab</title>
    <link rel="icon" href="data:,">

    <!-- 1. 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. 引入 React 和 ReactDOM (UMD 版本) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. 引入 Babel (用於解析 JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. 引入字體 -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        body:not(:defined) { opacity: 0; transition: opacity 0.2s; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- 1. 內建圖標組件 ---
        const IconBase = ({ children, className, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                {children}
            </svg>
        );

        const Eye = (props) => <IconBase {...props}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></IconBase>;
        const BookOpen = (props) => <IconBase {...props}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></IconBase>;
        const Layers = (props) => <IconBase {...props}><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></IconBase>;
        const Sun = (props) => <IconBase {...props}><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></IconBase>;
        const Mountain = (props) => <IconBase {...props}><path d="m8 3 4 8 5-5 5 15H2L8 3z"/></IconBase>;
        const Book = (props) => <IconBase {...props}><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></IconBase>;
        const MoveHorizontal = (props) => <IconBase {...props}><polyline points="18 8 22 12 18 16"/><polyline points="6 8 2 12 6 16"/><line x1="2" x2="22" y1="12" y2="12"/></IconBase>;
        const MoveVertical = (props) => <IconBase {...props}><polyline points="8 18 12 22 16 18"/><polyline points="8 6 12 2 16 6"/><line x1="12" x2="12" y1="2" y2="22"/></IconBase>;
        const Glasses = (props) => <IconBase {...props}><circle cx="6" cy="15" r="4"/><circle cx="18" cy="15" r="4"/><path d="M14 15a2 2 0 0 0-2-2 2 2 0 0 0-2 2"/><path d="M2.5 13 5 7c.7-1.3 1.4-2 3-2"/><path d="M21.5 13 19 7c-.7-1.3-1.5-2-3-2"/></IconBase>;
        const CheckCircle = (props) => <IconBase {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconBase>;
        const AlertCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconBase>;
        const Hand = (props) => <IconBase {...props}><path d="M18 11V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v0"/><path d="M14 10V4a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v2"/><path d="M10 10.5V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v8"/><path d="M18 8a2 2 0 1 1 4 0v6a8 8 0 0 1-8 8h-2c-2.8 0-4.5-.86-5.99-2.34l-3.6-3.6a2 2 0 0 1 2.83-2.82L7 15"/></IconBase>;
        const Laptop = (props) => <IconBase {...props}><path d="M20 16V7a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v9m16 0H4m16 0 1.28 2.55a1 1 0 0 1-.9 1.45H3.62a1 1 0 0 1-.9-1.45L4 16"/></IconBase>;
        const Contact = (props) => <IconBase {...props}><path d="M17 18a2 2 0 0 0-2-2H9a2 2 0 0 0-2 2"/><rect width="18" height="18" x="3" y="4" rx="2"/><circle cx="12" cy="10" r="2"/><line x1="8" x2="8" y1="2" y2="4"/><line x1="16" x2="16" y1="2" y2="4"/></IconBase>;
        const ArrowRightLeft = (props) => <IconBase {...props}><path d="m16 3 4 4-4 4"/><path d="M20 7H4"/><path d="m8 21-4-4 4-4"/><path d="M4 17h16"/></IconBase>;
        const Calculator = (props) => <IconBase {...props}><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></IconBase>;
        const Home = (props) => <IconBase {...props}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></IconBase>;
        const Building = (props) => <IconBase {...props}><rect width="16" height="20" x="4" y="2" rx="2" ry="2"/><path d="M9 22v-4h6v4"/><path d="M8 6h.01"/><path d="M16 6h.01"/><path d="M12 6h.01"/><path d="M12 10h.01"/><path d="M12 14h.01"/><path d="M16 10h.01"/><path d="M16 14h.01"/><path d="M8 10h.01"/><path d="M8 14h.01"/></IconBase>;
        const Moon = (props) => <IconBase {...props}><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></IconBase>;
        const Palette = (props) => <IconBase {...props}><circle cx="13.5" cy="6.5" r=".5"/><circle cx="17.5" cy="10.5" r=".5"/><circle cx="8.5" cy="7.5" r=".5"/><circle cx="6.5" cy="12.5" r=".5"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"/></IconBase>;
        const Info = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></IconBase>;
        const ChevronDown = (props) => <IconBase {...props}><path d="m6 9 6 6 6-6"/></IconBase>;
        const ChevronUp = (props) => <IconBase {...props}><path d="m18 15-6-6-6 6"/></IconBase>;

        // --- 2. 全局樣式 ---
        const GlobalStyles = () => (
            <style>{`
                .slider-thumb::-webkit-slider-thumb {
                    -webkit-appearance: none; appearance: none;
                    width: 24px; height: 24px; background: #3b82f6; cursor: pointer; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                }
                .slider-thumb::-moz-range-thumb {
                    width: 24px; height: 24px; background: #3b82f6; cursor: pointer; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                }
                .writing-mode-vertical {
                    writing-mode: vertical-lr;
                    direction: rtl;
                }
                @keyframes pulse-slow {
                    0%, 100% { opacity: 1; }
                    50% { opacity: 0.8; }
                }
                @keyframes fade-in {
                    from { opacity: 0; transform: translateY(10px); }
                    to { opacity: 1; transform: translateY(0); }
                }
                .animate-fade-in {
                    animation: fade-in 0.3s ease-out forwards;
                }
            `}</style>
        );

        // --- 3. 導覽列 ---
        const Navigation = ({ activeTab, setActiveTab }) => {
            const tabs = [
                { id: 'refraction', label: '屈光實驗', icon: Eye },
                { id: 'presbyopia', label: '老花眼', icon: BookOpen },
                { id: 'progressive', label: '多焦點', icon: Layers },
                { id: 'filters', label: '特殊鏡片', icon: Sun },
            ];

            return (
                <div className="fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 shadow-lg z-50 safe-area-bottom">
                    <div className="flex justify-around items-center h-16">
                        {tabs.map(tab => (
                            <button
                                key={tab.id}
                                onClick={() => setActiveTab(tab.id)}
                                className={`flex flex-col items-center justify-center w-full h-full transition-colors ${activeTab === tab.id ? 'text-blue-600' : 'text-gray-400'}`}
                            >
                                <tab.icon className="w-6 h-6 mb-1" />
                                <span className="text-xs font-medium">{tab.label}</span>
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        // --- 4. 屈光實驗用眼球模型 ---
        const EyeModel = ({ refractiveError, lensPower, correctionType, astigmatism, correctAstigmatism, effectivePower }) => {
            const retinaX = 292; 
            const netError = refractiveError - effectivePower;
            
            let focalPointX = retinaX;
            if (netError < 0) focalPointX = retinaX - (Math.abs(netError) * 12);
            else if (netError > 0) focalPointX = retinaX + (Math.abs(netError) * 12);

            const hasResidualAstigmatism = astigmatism > 0 && !correctAstigmatism;
            const secondaryFocalPointX = hasResidualAstigmatism ? focalPointX - (astigmatism * 15) : focalPointX;

            let rayColor = "#FFD700";
            const isPrimaryFocused = Math.abs(focalPointX - retinaX) < 5;
            const isSecondaryFocused = Math.abs(secondaryFocalPointX - retinaX) < 5;
            if (isPrimaryFocused && isSecondaryFocused) {
                rayColor = "#34D399"; 
            } else {
                rayColor = "#EF4444"; 
            }

            const isConcave = lensPower < -0.1;
            const isConvex = lensPower > 0.1;
            const lensX = correctionType === 'contact' ? 160 : 125;
            
            const lensPath = correctionType === 'contact' 
                ? `M ${lensX} 55 Q ${lensX+10} 75 ${lensX} 95` 
                : (isConcave 
                    ? `M ${lensX+5} 35 Q ${lensX+15} 75 ${lensX+5} 115 L ${lensX} 115 Q ${lensX+10} 75 ${lensX} 35 Z`
                    : `M ${lensX} 35 Q ${lensX+20} 75 ${lensX} 115 L ${lensX+5} 115 Q ${lensX+25} 75 ${lensX+5} 35 Z`);

            return (
                <div className="w-full bg-slate-900 rounded-xl p-4 shadow-inner overflow-hidden relative" style={{ height: '200px' }}>
                    <svg viewBox="0 0 350 150" className="w-full h-full">
                        <ellipse cx="230" cy="75" rx="65" ry="65" fill="#f1f5f9" stroke="#94a3b8" strokeWidth="2" />
                        <path d="M 175 75 Q 165 25 230 10" fill="none" stroke="#cbd5e1" strokeWidth="1" opacity="0.5" />
                        <path d="M 175 75 Q 165 125 230 140" fill="none" stroke="#cbd5e1" strokeWidth="1" opacity="0.5" />
                        
                        <path d="M 285 45 A 60 60 0 0 1 285 105" fill="none" stroke="#ef4444" strokeWidth="3" opacity="0.8" />
                        <text x="315" y="78" fill="#ef4444" fontSize="10" fontWeight="bold">視網膜</text>
                        
                        <ellipse cx="170" cy="75" rx="8" ry="40" fill="#93c5fd" opacity="0.8" />

                        {(isConcave || isConvex) && (
                            <path d={lensPath} fill="#bae6fd" stroke="#60a5fa" strokeWidth="1" opacity="0.8" />
                        )}

                        {correctionType === 'glasses' && (isConcave || isConvex) && (
                            <g>
                                <line x1="135" y1="130" x2="165" y2="130" stroke="white" strokeWidth="1" strokeDasharray="2,2" />
                                <line x1="135" y1="125" x2="135" y2="135" stroke="white" strokeWidth="1" />
                                <line x1="165" y1="125" x2="165" y2="135" stroke="white" strokeWidth="1" />
                                <text x="150" y="142" fill="white" fontSize="8" textAnchor="middle">12mm</text>
                            </g>
                        )}

                        <g stroke={rayColor} strokeWidth="2" opacity="0.9">
                            <line x1="0" y1="45" x2={(isConcave || isConvex) ? lensX : 170} y2="45" />
                            {(isConcave || isConvex) && <line x1={lensX} y1="45" x2="170" y2="45" strokeDasharray="2,2"/>}
                            <line x1="170" y1="45" x2={focalPointX} y2="75" />

                            <line x1="0" y1="105" x2={(isConcave || isConvex) ? lensX : 170} y2="105" />
                            {(isConcave || isConvex) && <line x1={lensX} y1="105" x2="170" y2="105" strokeDasharray="2,2"/>}
                            <line x1="170" y1="105" x2={focalPointX} y2="75" />
                        </g>

                        {hasResidualAstigmatism && (
                            <g stroke="#60A5FA" strokeWidth="1.5" strokeDasharray="4,3" opacity="0.8">
                                <line x1="170" y1="48" x2={secondaryFocalPointX} y2="75" />
                                <line x1="170" y1="102" x2={secondaryFocalPointX} y2="75" />
                            </g>
                        )}
                        
                        <line x1="0" y1="75" x2={Math.max(focalPointX, secondaryFocalPointX)} y2="75" stroke={rayColor} strokeWidth="1" opacity="0.3" />

                        <circle cx={focalPointX} cy="75" r="3" fill={rayColor} className="animate-pulse" />
                        <text x={focalPointX} y="95" fill={rayColor} fontSize="8" textAnchor="middle">焦點1</text>

                        {hasResidualAstigmatism && (
                            <g>
                                <circle cx={secondaryFocalPointX} cy="75" r="3" fill="#60A5FA" />
                                <text x={secondaryFocalPointX} y="60" fill="#60A5FA" fontSize="8" textAnchor="middle">焦點2 (散光)</text>
                            </g>
                        )}
                        
                        <text x="10" y="20" fill="white" fontSize="10">平行光源</text>
                    </svg>
                </div>
            )
        }

        // --- 5. 老花眼專用眼球模型 (新增) ---
        const PresbyopiaEyeModel = ({ age, viewDistance, hasGlasses, isBlurry }) => {
            const retinaX = 292;
            // 晶狀體彈性係數 (模擬)
            const elasticity = Math.max(0, 1 - (age - 20) / 40); 
            
            // 晶狀體形狀變化
            // 初始(看遠/放鬆): 扁平, 厚度小
            // 目標(看近/用力): 圓潤, 厚度大
            const minThickness = 5; 
            const maxThickness = 15; // 理想的最大調節厚度
            
            // 實際厚度
            let currentThickness = minThickness;
            if (viewDistance === 'near') {
                // 嘗試調節: 基礎 + (能力範圍 * 彈性)
                currentThickness = minThickness + (maxThickness - minThickness) * elasticity;
            }

            // 焦點計算
            let focalPointX = retinaX; // 預設看遠是清楚的 (假設無遠視)
            let rayColor = "#34D399"; // 綠色

            if (viewDistance === 'near') {
                // 光線來源是近處，需要晶狀體變厚(強屈光)來聚焦
                // 理想需要的屈光力對應 maxThickness
                // 如果 currentThickness < maxThickness，聚焦能力不足，焦點會跑到視網膜後方
                if (currentThickness < maxThickness * 0.9) { // 0.9 是一個容許值
                    // 聚焦不足，焦點後移
                    // 偏移量跟 (理想 - 實際) 成正比
                    const deficit = maxThickness - currentThickness;
                    focalPointX = retinaX + deficit * 8; 
                    rayColor = "#EF4444"; // 紅色 (模糊)
                }
            }

            // 加上老花眼鏡 (凸透鏡) 輔助
            if (viewDistance === 'near' && hasGlasses) {
                // 眼鏡提供額外屈光力，將焦點拉回視網膜
                focalPointX = retinaX;
                rayColor = "#34D399";
            }

            // 視覺化晶狀體路徑 (根據厚度變化)
            // 使用 Q 曲線模擬晶狀體鼓起
            // 上下頂點固定 Y=35, Y=115. 中心 X=170.
            // 控制點 X 隨厚度變化
            const lensPath = `M 170 35 Q ${170 + currentThickness} 75 170 115 Q ${170 - currentThickness} 75 170 35 Z`;

            // 光線起點與路徑
            // 看遠：平行光 (Y=45, Y=105)
            // 看近：發散光 (從 X=0, Y=75 出發，到達晶狀體/眼鏡)
            const startY_Top = viewDistance === 'far' ? 45 : 75;
            const startY_Bottom = viewDistance === 'far' ? 105 : 75;
            const lensEntryX = hasGlasses ? 135 : 170;
            
            // 眼鏡參數 (凸透鏡)
            const glassPath = `M 135 35 Q 145 75 135 115 L 130 115 Q 140 75 130 35 Z`;

            return (
                <div className="w-full bg-slate-900 rounded-xl p-4 shadow-inner overflow-hidden relative" style={{ height: '240px' }}>
                    <svg viewBox="0 0 350 150" className="w-full h-full">
                        {/* 眼球 */}
                        <ellipse cx="230" cy="75" rx="65" ry="65" fill="#f1f5f9" stroke="#94a3b8" strokeWidth="2" />
                        <path d="M 175 75 Q 165 25 230 10" fill="none" stroke="#cbd5e1" strokeWidth="1" opacity="0.5" />
                        <path d="M 175 75 Q 165 125 230 140" fill="none" stroke="#cbd5e1" strokeWidth="1" opacity="0.5" />
                        <path d="M 285 45 A 60 60 0 0 1 285 105" fill="none" stroke="#ef4444" strokeWidth="3" opacity="0.8" />
                        <text x="315" y="78" fill="#ef4444" fontSize="10" fontWeight="bold">視網膜</text>

                        {/* 晶狀體 (動態形狀) */}
                        <path d={lensPath} fill="#93c5fd" opacity="0.9" stroke="#3b82f6" strokeWidth="1" />

                        {/* 睫狀肌示意 (上下兩塊，隨距離移動模擬收縮) */}
                        {/* 放鬆(看遠): 離得遠 / 收縮(看近): 靠得近 */}
                        <rect x="162" y={viewDistance === 'near' ? 20 : 10} width="16" height="10" rx="2" fill="#fca5a5" />
                        <rect x="162" y={viewDistance === 'near' ? 120 : 130} width="16" height="10" rx="2" fill="#fca5a5" />
                        {/* 懸韌帶 (連接肌肉與晶狀體) */}
                        <line x1="170" y1={viewDistance === 'near' ? 30 : 20} x2="170" y2="35" stroke="#94a3b8" strokeWidth="1" />
                        <line x1="170" y1={viewDistance === 'near' ? 120 : 130} x2="170" y2="115" stroke="#94a3b8" strokeWidth="1" />
                        
                        <text x="190" y="25" fill="#fca5a5" fontSize="8">睫狀肌</text>

                        {/* 老花眼鏡 */}
                        {hasGlasses && (
                            <g>
                                <path d={glassPath} fill="#bae6fd" stroke="#60a5fa" strokeWidth="1" opacity="0.8" />
                                <text x="130" y="25" fill="#60a5fa" fontSize="8" textAnchor="middle">老花鏡片(+)</text>
                            </g>
                        )}

                        {/* 光線 */}
                        <g stroke={rayColor} strokeWidth="2" opacity="0.8">
                            {/* 上光束 */}
                            <line x1="0" y1={viewDistance === 'far' ? 45 : 75} x2={hasGlasses ? 135 : 165} y2="45" />
                            {hasGlasses && <line x1="135" y1="45" x2="165" y2="45" strokeDasharray="2,2" />}
                            <line x1="165" y1="45" x2={focalPointX} y2="75" />

                            {/* 下光束 */}
                            <line x1="0" y1={viewDistance === 'far' ? 105 : 75} x2={hasGlasses ? 135 : 165} y2="105" />
                            {hasGlasses && <line x1="135" y1="105" x2="165" y2="105" strokeDasharray="2,2" />}
                            <line x1="165" y1="105" x2={focalPointX} y2="75" />
                        </g>
                        
                        {/* 光源點 (看近時) */}
                        {viewDistance === 'near' && <circle cx="0" cy="75" r="4" fill="white" />}

                        {/* 焦點 */}
                        <circle cx={focalPointX} cy="75" r="3" fill={rayColor} className="animate-pulse" />

                        <text x="10" y="140" fill="white" fontSize="10">
                            {viewDistance === 'far' ? '遠處光源 (平行光)' : '近處物體 (發散光)'}
                        </text>
                    </svg>
                </div>
            );
        };

        // --- 6. 屈光不正頁面 ---
        const RefractionPage = () => {
            const [eyeCondition, setEyeCondition] = useState(-5);
            const [astigmatism, setAstigmatism] = useState(0); 
            const [lensPower, setLensPower] = useState(0); 
            const [correctAstigmatism, setCorrectAstigmatism] = useState(false); 
            const [correctionType, setCorrectionType] = useState('glasses'); 
            const [scene, setScene] = useState('outdoor');
            
            const [controlMode, setControlMode] = useState('diagnosis'); 
            const [showVertexInfo, setShowVertexInfo] = useState(false);

            const d = 0.012;
            let effectiveLensPower = lensPower;
            if (correctionType === 'glasses' && lensPower !== 0) {
                effectiveLensPower = lensPower / (1 - (d * lensPower));
            }
            const netError = eyeCondition - effectiveLensPower;
            
            const isSpherePerfect = Math.abs(netError) < 0.25;
            const isAstigmatismFixed = astigmatism === 0 || correctAstigmatism;
            
            const baseBlur = Math.abs(netError); 
            const astigmatismBlur = (!correctAstigmatism ? astigmatism : 0);
            const visualFilter = `
                blur(${baseBlur * 2 + astigmatismBlur}px) 
                ${astigmatismBlur > 0 ? `drop-shadow(${astigmatismBlur * 4}px ${astigmatismBlur * 4}px 0px rgba(0,0,0,0.3))` : ''}
            `;

            let statusText = "未矯正";
            let statusColor = "text-slate-500";
            let StatusIcon = AlertCircle;

            if (lensPower !== 0 || correctAstigmatism) {
                if (isSpherePerfect && isAstigmatismFixed) {
                    statusText = "完美矯正";
                    statusColor = "text-green-600";
                    StatusIcon = CheckCircle;
                } else if (astigmatism > 0 && !correctAstigmatism) {
                    statusText = "殘留散光";
                    statusColor = "text-orange-500";
                    StatusIcon = AlertCircle;
                } else if ((eyeCondition < 0 && netError < -0.25) || (eyeCondition > 0 && netError > 0.25)) {
                    statusText = "度數不足";
                    statusColor = "text-orange-500";
                    StatusIcon = AlertCircle;
                } else {
                    statusText = "過度矯正";
                    statusColor = "text-red-500";
                    StatusIcon = AlertCircle;
                }
            }

            const recommendedContact = eyeCondition;
            const recommendedGlasses = eyeCondition / (1 + d * eyeCondition);
            const formatDiopter = (val) => {
                const num = Math.round(val * 4) / 4;
                const sign = num > 0 ? '+' : '';
                const degrees = Math.abs(Math.round(num * 100));
                return { text: `${sign}${num.toFixed(2)} D`, degree: `${degrees}度` };
            };
            const contactDisplay = formatDiopter(recommendedContact);
            const glassesDisplay = formatDiopter(recommendedGlasses);
            const isMyopia = eyeCondition < 0;
            const isHyperopia = eyeCondition > 0;
            const isNormal = Math.abs(eyeCondition) <= 0.5;
            let lensMin = 0, lensMax = 0;
            if (isMyopia) { lensMin = -10; lensMax = 0; }
            if (isHyperopia) { lensMin = 0; lensMax = 10; } 

            const sceneImage = scene === 'outdoor' 
                ? "https://images.unsplash.com/photo-1477959858617-67f85cf4f1df?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80"
                : "https://images.unsplash.com/photo-1524758631624-e2822e304c36?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80";

            return (
                <div className="space-y-4 pb-24">
                    <div className="bg-white p-3 rounded-2xl shadow-sm border border-slate-100">
                        <EyeModel 
                            refractiveError={eyeCondition} 
                            lensPower={lensPower} 
                            correctionType={correctionType}
                            astigmatism={astigmatism}
                            correctAstigmatism={correctAstigmatism}
                            effectivePower={effectiveLensPower}
                        />
                        
                        <div className="relative w-full h-32 mt-2 rounded-xl overflow-hidden shadow-inner group">
                            <img 
                                src={sceneImage} 
                                className="w-full h-full object-cover transition-all duration-300"
                                style={{ filter: visualFilter }} 
                                alt="Simulation"
                            />
                            <div className="absolute top-2 left-2 bg-black/60 text-white text-[10px] px-2 py-1 rounded backdrop-blur-sm">
                                {statusText} {astigmatism > 0 && !correctAstigmatism ? "(含疊影)" : ""}
                            </div>
                            <div className="absolute top-2 right-2 flex bg-black/40 rounded-lg p-0.5 backdrop-blur-sm border border-white/20">
                                <button onClick={() => setScene('outdoor')} className={`p-1 rounded ${scene === 'outdoor' ? 'bg-white text-slate-900' : 'text-white'}`}><Building className="w-3 h-3" /></button>
                                <button onClick={() => setScene('indoor')} className={`p-1 rounded ${scene === 'indoor' ? 'bg-white text-slate-900' : 'text-white'}`}><Home className="w-3 h-3" /></button>
                            </div>
                        </div>
                    </div>

                    <div className="bg-white rounded-2xl shadow-lg border border-slate-100 overflow-hidden">
                        <div className="flex border-b border-slate-100">
                            <button 
                                onClick={() => setControlMode('diagnosis')}
                                className={`flex-1 py-3 text-sm font-bold flex items-center justify-center gap-2 transition-colors ${controlMode === 'diagnosis' ? 'bg-blue-50 text-blue-600 border-b-2 border-blue-600' : 'text-slate-400 hover:bg-slate-50'}`}
                            >
                                <Eye className="w-4 h-4" /> 1. 設定眼睛
                            </button>
                            <button 
                                onClick={() => setControlMode('clinic')}
                                className={`flex-1 py-3 text-sm font-bold flex items-center justify-center gap-2 transition-colors ${controlMode === 'clinic' ? 'bg-green-50 text-green-600 border-b-2 border-green-600' : 'text-slate-400 hover:bg-slate-50'}`}
                            >
                                <Glasses className="w-4 h-4" /> 2. 驗光配鏡
                            </button>
                        </div>

                        <div className="p-5 min-h-[200px]">
                            {controlMode === 'diagnosis' ? (
                                <div className="space-y-6 animate-fade-in">
                                    <div>
                                        <div className="flex justify-between text-sm font-medium mb-2">
                                            <span className="flex items-center gap-1 text-slate-700"><ArrowRightLeft className="w-3 h-3"/> 近視 / 遠視</span>
                                            <span className="text-blue-600 font-bold">
                                                {eyeCondition > 0 ? '+' : ''}{eyeCondition} D 
                                                <span className="text-xs ml-1 text-slate-400 font-normal">
                                                    ({eyeCondition === 0 ? "無度數" : `${Math.abs(eyeCondition) * 100}度`})
                                                </span>
                                            </span>
                                        </div>
                                        <input 
                                            type="range" min="-10" max="10" step="0.5" 
                                            value={eyeCondition} 
                                            onChange={(e) => setEyeCondition(parseFloat(e.target.value))}
                                            className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer slider-thumb"
                                        />
                                        <div className="flex justify-between text-[10px] text-slate-400 mt-1 px-1">
                                            <span>高度近視</span><span>正常</span><span>高度遠視</span>
                                        </div>
                                    </div>

                                    <div>
                                        <div className="flex justify-between text-sm font-medium mb-2">
                                            <span className="flex items-center gap-1 text-slate-700"><Layers className="w-3 h-3"/> 散光程度</span>
                                            <span className="text-slate-500 text-xs">{astigmatism === 0 ? "無" : `散光 ${astigmatism*50}度`}</span>
                                        </div>
                                        <input 
                                            type="range" min="0" max="3" step="1" 
                                            value={astigmatism} 
                                            onChange={(e) => setAstigmatism(parseInt(e.target.value))}
                                            className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer slider-thumb"
                                        />
                                    </div>
                                </div>
                            ) : (
                                <div className="space-y-5 animate-fade-in">
                                    <div className="flex bg-slate-100 p-1 rounded-lg">
                                        <button 
                                            onClick={() => setCorrectionType('glasses')}
                                            className={`flex-1 py-1.5 text-xs font-medium rounded-md transition-all flex items-center justify-center gap-1 ${correctionType === 'glasses' ? 'bg-white shadow text-slate-800' : 'text-slate-400'}`}
                                        >
                                            <Glasses className="w-3 h-3" /> 一般眼鏡
                                        </button>
                                        <button 
                                            onClick={() => setCorrectionType('contact')}
                                            className={`flex-1 py-1.5 text-xs font-medium rounded-md transition-all flex items-center justify-center gap-1 ${correctionType === 'contact' ? 'bg-white shadow text-slate-800' : 'text-slate-400'}`}
                                        >
                                            <Contact className="w-3 h-3" /> 隱形眼鏡
                                        </button>
                                    </div>

                                    <div>
                                        <div className="flex justify-between text-sm font-medium mb-2">
                                            <span className="text-slate-700">鏡片度數</span>
                                            <span className="text-blue-600 font-bold">
                                                {lensPower === 0 ? "未配戴" : 
                                                    <span>{lensPower > 0 ? '+' : ''}{lensPower} D <span className="text-xs font-normal text-slate-400">({Math.abs(lensPower) * 100}度)</span></span>
                                                }
                                            </span>
                                        </div>
                                        <input 
                                            type="range" 
                                            min={lensMin} max={lensMax} step="0.25"
                                            disabled={isNormal}
                                            value={lensPower} 
                                            onChange={(e) => setLensPower(parseFloat(e.target.value))}
                                            className={`w-full h-2 rounded-lg appearance-none cursor-pointer slider-thumb ${isNormal ? 'bg-slate-100' : 'bg-gradient-to-r from-blue-100 to-blue-200'}`}
                                        />
                                    </div>

                                    {astigmatism > 0 && (
                                        <div 
                                            onClick={() => setCorrectAstigmatism(!correctAstigmatism)}
                                            className={`flex items-center justify-between p-3 rounded-lg border cursor-pointer transition-all ${correctAstigmatism ? 'bg-orange-50 border-orange-200' : 'bg-white border-slate-200'}`}
                                        >
                                            <span className="text-sm font-medium text-slate-700">矯正散光 ({astigmatism*50}度)</span>
                                            <div className={`w-10 h-5 rounded-full relative transition-colors ${correctAstigmatism ? 'bg-orange-500' : 'bg-slate-300'}`}>
                                                <div className={`absolute top-1 left-1 w-3 h-3 bg-white rounded-full transition-transform ${correctAstigmatism ? 'translate-x-5' : 'translate-x-0'}`}></div>
                                            </div>
                                        </div>
                                    )}

                                    <div className="border-t border-slate-100 pt-2">
                                        <button 
                                            onClick={() => setShowVertexInfo(!showVertexInfo)}
                                            className="flex items-center justify-between w-full text-xs text-slate-400 hover:text-slate-600 py-1"
                                        >
                                            <span className="flex items-center gap-1"><Calculator className="w-3 h-3"/> 頂點距離換算建議</span>
                                            {showVertexInfo ? <ChevronUp className="w-3 h-3" /> : <ChevronDown className="w-3 h-3" />}
                                        </button>
                                        
                                        {/* 頂點距離資訊永遠存在，只是用 CSS 隱藏/顯示，或保留在 DOM 中 */}
                                        <div className={`mt-2 bg-slate-50 rounded-lg p-3 text-xs animate-fade-in ${showVertexInfo ? 'block' : 'hidden'}`}>
                                            <p className="mb-2 text-slate-500">眼鏡距角膜 12mm，隱眼貼合角膜 (0mm)，高度數時需換算。</p>
                                            <div className="grid grid-cols-2 gap-2 text-center">
                                                <div className="bg-white p-1 rounded border border-slate-100">
                                                    <div className="text-slate-400 scale-90">隱眼建議</div>
                                                    <div className="font-bold text-blue-600">{contactDisplay.text}</div>
                                                </div>
                                                <div className="bg-white p-1 rounded border border-slate-100">
                                                    <div className="text-slate-400 scale-90">眼鏡建議</div>
                                                    <div className="font-bold text-indigo-600">{glassesDisplay.text}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- 7. 老花眼頁面 (更新後) ---
        const PresbyopiaPage = () => {
            const [age, setAge] = useState(20);
            const [viewDistance, setViewDistance] = useState('near');
            const [hasReadingGlasses, setHasReadingGlasses] = useState(false);

            const elasticity = Math.max(0, 1 - (age - 20) / 40); 
            const needsAccommodation = viewDistance === 'near';
            const canAccommodate = elasticity >= 0.3;
            const isBlurry = needsAccommodation && !canAccommodate && !hasReadingGlasses;

            useEffect(() => {
                if (viewDistance === 'far') setHasReadingGlasses(false);
            }, [viewDistance]);

            return (
                <div className="space-y-6 pb-20">
                    <div className="bg-white p-3 rounded-2xl shadow-sm border border-slate-100">
                        <h2 className="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                            <BookOpen className="text-orange-500 w-6 h-6" />
                            老花眼：失去的調節力
                        </h2>
                        
                        {/* 使用新的老花眼專用模型 */}
                        <PresbyopiaEyeModel 
                            age={age}
                            viewDistance={viewDistance}
                            hasGlasses={hasReadingGlasses}
                            isBlurry={isBlurry}
                        />
                    </div>

                    <div className="bg-white rounded-2xl shadow-lg border border-slate-100 p-5">
                        <div className="space-y-6">
                            <div>
                                <label className="flex justify-between text-sm font-medium mb-2">
                                    <span>年齡模擬</span>
                                    <span className="text-orange-600 font-bold">{age} 歲</span>
                                </label>
                                <input 
                                    type="range" min="20" max="70" step="5" 
                                    value={age} 
                                    onChange={(e) => setAge(parseInt(e.target.value))}
                                    className="w-full h-2 bg-orange-100 rounded-lg appearance-none cursor-pointer slider-thumb"
                                />
                                <div className="flex justify-between text-xs text-slate-400 mt-1">
                                    <span>20歲 (彈性佳)</span>
                                    <span>70歲 (硬化)</span>
                                </div>
                            </div>

                            <div className="flex gap-2">
                                <button 
                                    onClick={() => setViewDistance('far')}
                                    className={`flex-1 py-3 rounded-lg flex items-center justify-center gap-2 border transition-all ${viewDistance === 'far' ? 'bg-slate-800 text-white' : 'bg-white text-slate-600 hover:bg-slate-50'}`}>
                                    <Mountain className="w-4 h-4" /> 看遠處風景
                                </button>
                                <button 
                                    onClick={() => setViewDistance('near')}
                                    className={`flex-1 py-3 rounded-lg flex items-center justify-center gap-2 border transition-all ${viewDistance === 'near' ? 'bg-orange-500 text-white' : 'bg-white text-slate-600 hover:bg-orange-50'}`}>
                                    <Book className="w-4 h-4" /> 看手機/書本
                                </button>
                            </div>

                            <div 
                                onClick={() => viewDistance === 'near' && elasticity < 0.3 && setHasReadingGlasses(!hasReadingGlasses)}
                                className={`p-4 rounded-xl border transition-all cursor-pointer ${viewDistance === 'near' && elasticity < 0.3 ? 'bg-blue-50 border-blue-200' : 'bg-slate-50 border-slate-100 opacity-50 pointer-events-none'}`}
                            >
                                <div className="flex items-center justify-between mb-2">
                                    <span className="font-bold text-sm text-slate-700 flex items-center gap-2">
                                        <Glasses className="w-4 h-4" /> 配戴老花眼鏡
                                    </span>
                                    <div className={`relative w-12 h-6 rounded-full transition-colors ${hasReadingGlasses ? 'bg-blue-600' : 'bg-slate-300'}`}>
                                        <div className={`absolute top-1 left-1 w-4 h-4 bg-white rounded-full transition-transform ${hasReadingGlasses ? 'translate-x-6' : 'translate-x-0'}`}></div>
                                    </div>
                                </div>
                                <p className="text-xs text-slate-500">
                                    當晶狀體變硬無法對焦近物時，使用<strong>凸透鏡（單焦老花眼鏡）</strong>可以幫助匯聚光線。
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    {/* 視覺模擬圖 */}
                    <div className="relative w-full h-48 rounded-2xl overflow-hidden shadow-md">
                        <img 
                            src={viewDistance === 'near' ? "https://images.unsplash.com/photo-1544716278-ca5e3f4abd8c?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80" : "https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80"}
                            className="w-full h-full object-cover transition-all duration-700"
                            style={{ filter: isBlurry ? 'blur(5px)' : 'blur(0px)' }}
                            alt="Presbyopia Sim"
                        />
                        <div className="absolute top-2 left-2 bg-black/60 text-white text-xs px-2 py-1 rounded backdrop-blur-sm">
                            模擬視野
                        </div>
                        {isBlurry && (
                            <div className="absolute inset-0 flex items-center justify-center bg-black/20 backdrop-blur-[2px]">
                                <div className="bg-white/90 px-4 py-2 rounded-lg text-center shadow-lg">
                                    <p className="text-red-500 font-bold text-lg">看不清楚！</p>
                                    <p className="text-xs text-slate-600">晶狀體硬化，無法調節</p>
                                </div>
                            </div>
                        )}
                        {!isBlurry && viewDistance === 'near' && hasReadingGlasses && (
                             <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                                <div className="bg-blue-600/90 text-white px-4 py-2 rounded-lg text-center shadow-lg animate-fade-in">
                                    <p className="font-bold">清晰！</p>
                                    <p className="text-xs opacity-90">老花眼鏡輔助對焦</p>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            )
        }

        // --- 8. 多焦點頁面 ---
        const ProgressivePage = () => {
            const [headTilt, setHeadTilt] = useState(50); 
            const [eyePosition, setEyePosition] = useState(50);
            const containerRef = useRef(null);
            const [isDragging, setIsDragging] = useState(false);

            let zone = '';
            let isDistorted = false;

            if (headTilt > 60) zone = 'distance';
            else if (headTilt > 30) zone = 'intermediate';
            else zone = 'near';

            const centerWidth = zone === 'distance' ? 80 : (zone === 'intermediate' ? 20 : 40);
            const deviation = Math.abs(eyePosition - 50);
            
            if (deviation > centerWidth / 2) {
                isDistorted = true;
            }

            const handleInteractionStart = (e) => {
                setIsDragging(true);
                handleInteractionMove(e); 
            };

            const handleInteractionMove = (e) => {
                if (!isDragging && e.type !== 'mousedown' && e.type !== 'touchstart') return;

                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                
                if (containerRef.current) {
                    const rect = containerRef.current.getBoundingClientRect();
                    const x = clientX - rect.left;
                    const y = clientY - rect.top;
                    
                    let newEyePos = (x / rect.width) * 100;
                    let newHeadTilt = 100 - ((y / rect.height) * 100); 
                    
                    newEyePos = Math.max(0, Math.min(100, newEyePos));
                    newHeadTilt = Math.max(0, Math.min(100, newHeadTilt));
                    
                    setEyePosition(newEyePos);
                    setHeadTilt(newHeadTilt);
                }
            };

            const handleInteractionEnd = () => {
                setIsDragging(false);
            };

            return (
                <div className="space-y-6 pb-20">
                        <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                        <h2 className="text-xl font-bold text-slate-800 mb-2 flex items-center gap-2">
                            <Layers className="text-purple-600 w-6 h-6" />
                            多焦點鏡片原理
                        </h2>
                        <p className="text-sm text-slate-600 mb-4">
                            請直接在鏡框內<strong>按住紅點並拖曳</strong>，模擬眼球轉動與視線高低。保持在白色清晰區，進入黃色區會變形。
                        </p>

                        <div className="relative w-full aspect-[4/3] flex items-center justify-center p-2">
                            <div 
                                ref={containerRef}
                                className="relative w-full h-full bg-slate-900 overflow-hidden shadow-2xl cursor-pointer touch-none"
                                style={{
                                    // 威靈頓/倒梯形鏡框形狀
                                    borderRadius: '40% 40% 45% 45% / 45% 45% 55% 55%',
                                    border: '12px solid #1e293b', // 鏡框邊框
                                    boxShadow: 'inset 0 0 20px rgba(0,0,0,0.8), 0 10px 20px rgba(0,0,0,0.2)'
                                }}
                                onMouseDown={handleInteractionStart}
                                onTouchStart={handleInteractionStart}
                                onMouseMove={(e) => isDragging && handleInteractionMove(e)}
                                onTouchMove={(e) => isDragging && handleInteractionMove(e)}
                                onMouseUp={handleInteractionEnd}
                                onMouseLeave={handleInteractionEnd}
                                onTouchEnd={handleInteractionEnd}
                            >
                                <img 
                                    src={zone === 'distance' 
                                        ? "https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=600&q=80" 
                                        : zone === 'intermediate'
                                        ? "https://images.unsplash.com/photo-1517694712202-14dd9538aa97?auto=format&fit=crop&w=600&q=80"
                                        : "https://images.unsplash.com/photo-1589829085413-56de8ae18c73?auto=format&fit=crop&w=600&q=80" 
                                    }
                                    className="absolute inset-0 w-full h-full object-cover transition-all duration-300 pointer-events-none select-none"
                                    style={{ 
                                        filter: isDistorted ? 'blur(8px) skewX(5deg)' : 'blur(0px)',
                                        transform: isDistorted ? 'scale(1.1)' : 'scale(1)'
                                    }}
                                    alt="Progressive Lens Sim"
                                />
                                
                                <div className="absolute inset-0 bg-gradient-to-tr from-transparent via-white/5 to-transparent pointer-events-none"></div>

                                <svg className="absolute inset-0 w-full h-full pointer-events-none opacity-60 select-none" viewBox="0 0 100 100" preserveAspectRatio="none">
                                    <defs>
                                        <linearGradient id="distortionGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                            <stop offset="0%" stopColor="#fbbf24" stopOpacity="0.4" />
                                            <stop offset="40%" stopColor="#fbbf24" stopOpacity="0.1" />
                                            <stop offset="50%" stopColor="transparent" stopOpacity="0" />
                                            <stop offset="60%" stopColor="#fbbf24" stopOpacity="0.1" />
                                            <stop offset="100%" stopColor="#fbbf24" stopOpacity="0.4" />
                                        </linearGradient>
                                    </defs>
                                    
                                    <path d="M 0 0 L 10 0 C 10 20 40 30 40 60 C 40 80 30 90 30 100 L 0 100 Z" fill="#fbbf24" fillOpacity="0.3" stroke="#f59e0b" strokeWidth="0.5" strokeDasharray="2,2"/>
                                    <path d="M 100 0 L 90 0 C 90 20 60 30 60 60 C 60 80 70 90 70 100 L 100 100 Z" fill="#fbbf24" fillOpacity="0.3" stroke="#f59e0b" strokeWidth="0.5" strokeDasharray="2,2"/>
                                    
                                    <line x1="0" y1="35" x2="100" y2="35" stroke="white" strokeWidth="0.5" strokeDasharray="3,3" opacity="0.4"/>
                                    <line x1="0" y1="65" x2="100" y2="65" stroke="white" strokeWidth="0.5" strokeDasharray="3,3" opacity="0.4"/>
                                </svg>

                                <div 
                                    className={`absolute w-8 h-8 border-4 border-red-500 rounded-full shadow-[0_0_15px_rgba(255,0,0,0.9)] transform -translate-x-1/2 -translate-y-1/2 transition-transform duration-75 z-10 ${isDragging ? 'scale-125 bg-red-500/20' : 'scale-100'}`}
                                    style={{ 
                                        left: `${eyePosition}%`, 
                                        top: `${100 - headTilt}%` 
                                    }}
                                >
                                    <div className="absolute top-1/2 left-1/2 w-1.5 h-1.5 bg-red-500 rounded-full -translate-x-1/2 -translate-y-1/2"></div>
                                </div>
                                
                                {!isDragging && (
                                    <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 pointer-events-none opacity-40 animate-pulse text-white text-4xl filter drop-shadow-md">
                                        <Hand className="w-12 h-12 rotate-12" />
                                    </div>
                                )}
                            </div>
                        </div>

                        <div className="flex justify-center -mt-2">
                            <div className={`px-6 py-3 rounded-full text-base font-bold shadow-md transition-colors border-2 flex items-center gap-2 ${isDistorted ? 'bg-red-50 border-red-200 text-red-600' : 'bg-green-50 border-green-200 text-green-700'}`}>
                                {isDistorted ? (
                                    <>
                                        <AlertCircle className="w-5 h-5" />
                                        進入變形區 (模糊/頭暈)
                                    </>
                                ) : (
                                    <>
                                        <CheckCircle className="w-5 h-5" />
                                        {zone === 'distance' ? "遠用區：視野清晰" : zone === 'intermediate' ? "漸進帶：視野清晰" : "近用區：視野清晰"}
                                    </>
                                )}
                            </div>
                        </div>

                        <div className="text-center text-xs text-slate-400">
                             <span className="inline-block w-2 h-2 rounded-full bg-red-500 mr-1"></span>
                             紅點代表您的視線焦點
                        </div>
                    </div>
                </div>
            )
        }

        // --- 9. 特殊鏡片頁面 ---
        const FiltersPage = () => {
            const [activeFilter, setActiveFilter] = useState('none'); 

            const filters = {
                none: { class: '', label: '無濾鏡' },
                blue: { class: 'sepia-[30%] contrast-90 brightness-95 saturate-150', label: '抗藍光 (暖色)' },
                photochromic: { class: 'brightness-50 contrast-125 grayscale-[20%]', label: '變色片 (戶外)' },
                polarized: { class: 'contrast-125 saturate-125', label: '偏光鏡 (消反光)' },
                night: { class: 'sepia brightness-110 contrast-125 saturate-150', label: '夜間駕駛 (增強對比)' },
                colorblind: { class: 'contrast-150 saturate-200', label: '色覺輔助 (增強紅綠)' }
            };

            // 根據濾鏡類型切換情境圖片
            const getFilterImage = () => {
                if (activeFilter === 'blue') {
                    // 抗藍光模式：展示室內辦公環境 (筆電、白桌)，最能體現色溫變化
                    return "https://images.unsplash.com/photo-1498050108023-c5249f4df085?auto=format&fit=crop&w=800&q=80"; 
                }
                // 其他模式：展示戶外/海灘，適合偏光和變色片
                if (activeFilter === 'night') {
                    return "https://images.unsplash.com/photo-1519501025264-65ba15a82390?auto=format&fit=crop&w=800&q=80"; // Night City
                }
                if (activeFilter === 'colorblind') {
                    return "https://images.unsplash.com/photo-1502082553048-f009c37129b9?auto=format&fit=crop&w=800&q=80"; // Colorful Nature
                }
                return "https://images.unsplash.com/photo-1507525428034-b723cf961d3e?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80"; // Beach
            };

            return (
                <div className="space-y-6 pb-20">
                    <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                            <h2 className="text-xl font-bold text-slate-800 mb-2 flex items-center gap-2">
                            <Sun className="text-yellow-500 w-6 h-6" />
                            特殊功能鏡片
                        </h2>
                        
                        <div className="relative w-full aspect-video rounded-xl overflow-hidden shadow-lg mb-6 group bg-slate-100">
                            <img 
                                src={getFilterImage()}
                                className={`w-full h-full object-cover transition-all duration-700 ${filters[activeFilter].class}`}
                                alt="Scene"
                                key={activeFilter} // 強制重新渲染以觸發轉場動畫
                            />
                            
                            {activeFilter === 'polarized' && (
                                <div className="absolute bottom-4 left-1/4 text-white font-bold text-shadow animate-pulse">
                                    ✨ 水面反光消除，看見水底細節
                                </div>
                            )}

                            {activeFilter === 'blue' && (
                                 <div className="absolute bottom-4 left-4 bg-yellow-900/60 text-yellow-50 px-3 py-1 rounded-full text-xs font-bold backdrop-blur-sm animate-fade-in">
                                    <Laptop className="w-3 h-3 inline-block mr-1" />
                                    過濾螢幕冷光，畫面變柔和
                                </div>
                            )}

                            {activeFilter === 'night' && (
                                 <div className="absolute bottom-4 left-4 bg-yellow-500/60 text-white px-3 py-1 rounded-full text-xs font-bold backdrop-blur-sm animate-fade-in">
                                    <Moon className="w-3 h-3 inline-block mr-1" />
                                    黃色鏡片濾除散射藍光，增強夜間對比
                                </div>
                            )}

                            {activeFilter === 'colorblind' && (
                                 <div className="absolute bottom-4 left-4 bg-red-500/60 text-white px-3 py-1 rounded-full text-xs font-bold backdrop-blur-sm animate-fade-in">
                                    <Palette className="w-3 h-3 inline-block mr-1" />
                                    調節光譜，讓紅綠色彩更分明
                                </div>
                            )}
                            
                            {/* 鏡片邊框模擬 */}
                            <div className="absolute inset-0 border-[20px] border-black/80 rounded-[3rem] pointer-events-none opacity-80 scale-110 blur-sm"></div>
                            
                            <div className="absolute top-4 right-4 bg-black/70 text-white text-xs px-3 py-1 rounded-full backdrop-blur-sm">
                                模式: {filters[activeFilter].label}
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-3">
                            <button 
                                onClick={() => setActiveFilter('none')}
                                className={`p-3 rounded-xl border text-sm font-medium transition-all ${activeFilter === 'none' ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-600 hover:bg-slate-50'}`}>
                                裸眼 / 一般鏡片
                            </button>
                            <button 
                                onClick={() => setActiveFilter('photochromic')}
                                className={`p-3 rounded-xl border text-sm font-medium transition-all ${activeFilter === 'photochromic' ? 'bg-slate-800 text-white border-slate-800' : 'bg-gray-100 text-slate-600 hover:bg-gray-200'}`}>
                                變色鏡片 (模擬照光)
                            </button>
                            <button 
                                onClick={() => setActiveFilter('blue')}
                                className={`p-3 rounded-xl border text-sm font-medium transition-all ${activeFilter === 'blue' ? 'bg-yellow-100 border-yellow-300 text-yellow-800' : 'bg-white text-slate-600 hover:bg-yellow-50'}`}>
                                抗藍光鏡片
                            </button>
                            <button 
                                onClick={() => setActiveFilter('polarized')}
                                className={`p-3 rounded-xl border text-sm font-medium transition-all ${activeFilter === 'polarized' ? 'bg-teal-100 border-teal-300 text-teal-800' : 'bg-white text-slate-600 hover:bg-teal-50'}`}>
                                偏光太陽眼鏡
                            </button>
                            <button 
                                onClick={() => setActiveFilter('night')}
                                className={`p-3 rounded-xl border text-sm font-medium transition-all ${activeFilter === 'night' ? 'bg-yellow-500 text-white border-yellow-600' : 'bg-white text-slate-600 hover:bg-yellow-50'}`}>
                                夜間駕駛眼鏡
                            </button>
                            <button 
                                onClick={() => setActiveFilter('colorblind')}
                                className={`p-3 rounded-xl border text-sm font-medium transition-all ${activeFilter === 'colorblind' ? 'bg-pink-500 text-white border-pink-600' : 'bg-white text-slate-600 hover:bg-pink-50'}`}>
                                色覺輔助眼鏡
                            </button>
                        </div>

                            <div className="mt-4 p-4 bg-slate-50 rounded-xl text-sm text-slate-600 leading-relaxed">
                            {activeFilter === 'none' && "一般鏡片只負責矯正屈光，無法過濾有害光線或強烈眩光。"}
                            {activeFilter === 'photochromic' && "變色鏡片含有鹵化銀分子，遇到紫外線(UV)會迅速變黑，阻擋強光；回到室內則恢復透明。"}
                            {activeFilter === 'blue' && "抗藍光鏡片會過濾掉 380-500nm 的高能量藍光，畫面會略微偏黃，能減少螢幕對眼睛的刺激。"}
                            {activeFilter === 'polarized' && "偏光鏡就像百葉窗，只讓特定方向的光通過，能有效濾除路面、水面反射的刺眼雜光。"}
                            {activeFilter === 'night' && "夜間駕駛眼鏡通常為黃色，能濾除波長短的藍光（易散射眩光），提升夜間行車的對比度與清晰度。"}
                            {activeFilter === 'colorblind' && "色覺輔助眼鏡透過光譜濾波技術，調整進入眼睛的光線比例，幫助紅綠色弱人士更容易分辨色彩。"}
                        </div>
                    </div>
                </div>
            )
        }

        // --- 10. 主應用程式 ---
        const App = () => {
            const [activeTab, setActiveTab] = useState('refraction');

            const renderContent = () => {
                switch(activeTab) {
                    case 'refraction': return <RefractionPage />;
                    case 'presbyopia': return <PresbyopiaPage />;
                    case 'progressive': return <ProgressivePage />;
                    case 'filters': return <FiltersPage />;
                    default: return <RefractionPage />;
                }
            }

            return (
                <div className="min-h-screen bg-slate-50 text-slate-900 font-sans selection:bg-blue-100">
                    <GlobalStyles />
                    <header className="bg-white shadow-sm sticky top-0 z-10">
                        <div className="max-w-md mx-auto px-4 h-14 flex items-center justify-between">
                            <h1 className="font-bold text-lg text-slate-800 flex items-center gap-2">
                                <span className="bg-blue-600 text-white p-1 rounded-md">
                                    <Glasses className="w-5 h-5" />
                                </span>
                                視覺光學實驗室
                            </h1>
                        </div>
                    </header>

                    <main className="max-w-md mx-auto p-4 animate-fade-in">
                        {renderContent()}
                    </main>

                    <Navigation activeTab={activeTab} setActiveTab={setActiveTab} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
